

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>python.financial_functions &mdash; dgen  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> dgen
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">dGen Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#agent-based-model">agent based model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#dgen-database">dGen Database</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">dGen Code Base</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#subpackages">Subpackages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../python.agent_mutation.html">python.agent_mutation package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../python.agent_mutation.html#submodules">Submodules</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../python.agent_mutation.html#module-python.agent_mutation.elec">python.agent_mutation.elec module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../python.agent_mutation.html#module-python.agent_mutation">Module contents</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../python.excel.html">python.excel package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../python.excel.html#submodules">Submodules</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../python.excel.html#module-python.excel.excel_objects">python.excel.excel_objects module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../python.excel.html#module-python.excel">Module contents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-python.config">python.config module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-python.decorators">python.decorators module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-python.dgen_model">python.dgen_model module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-python.data_functions">python.data_functions module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-python.input_data_functions">python.input_data_functions module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-python.diffusion_functions_elec">python.diffusion_functions_elec module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-python.financial_functions">python.financial_functions module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-python.settings">python.settings module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-python.tariff_functions">python.tariff_functions module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-python.utility_functions">python.utility_functions module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-python">Module contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contribution Policy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../contributing.html#issue-overview">Issue overview</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">dgen</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>python.financial_functions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for python.financial_functions</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">decorators</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>

<span class="kn">import</span> <span class="nn">settings</span>
<span class="kn">import</span> <span class="nn">utility_functions</span> <span class="k">as</span> <span class="nn">utilfunc</span>
<span class="kn">import</span> <span class="nn">agent_mutation</span>

<span class="kn">import</span> <span class="nn">pyarrow</span> <span class="k">as</span> <span class="nn">pa</span>
<span class="kn">import</span> <span class="nn">pyarrow.parquet</span> <span class="k">as</span> <span class="nn">pq</span>

<span class="kn">import</span> <span class="nn">PySAM</span>
<span class="kn">import</span> <span class="nn">PySAM.Battwatts</span> <span class="k">as</span> <span class="nn">battery</span>
<span class="kn">import</span> <span class="nn">PySAM.BatteryTools</span> <span class="k">as</span> <span class="nn">batt_tools</span>
<span class="kn">import</span> <span class="nn">PySAM.Utilityrate5</span> <span class="k">as</span> <span class="nn">utility</span>
<span class="kn">import</span> <span class="nn">PySAM.Cashloan</span> <span class="k">as</span> <span class="nn">cashloan</span>


<span class="c1">#==============================================================================</span>
<span class="c1"># Load logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">utilfunc</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<span class="c1">#==============================================================================</span>


<span class="c1">#%%</span>
<div class="viewcode-block" id="calc_system_performance"><a class="viewcode-back" href="../../api.html#python.financial_functions.calc_system_performance">[docs]</a><span class="k">def</span> <span class="nf">calc_system_performance</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">utilityrate</span><span class="p">,</span> <span class="n">loan</span><span class="p">,</span> <span class="n">batt</span><span class="p">,</span> <span class="n">costs</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">rate_switch_table</span><span class="p">,</span> <span class="n">en_batt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batt_simple_dispatch</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes Battwatts, Utilityrate5, and Cashloan PySAM modules with system sizes (kw) as input</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kw: Capacity (in kW)</span>
<span class="sd">    pv: Dictionary with generation_hourly and consumption_hourly</span>
<span class="sd">    utilityrate: PySAM Utilityrate5 module</span>
<span class="sd">    loan: PySAM Cashloan module</span>
<span class="sd">    batt: PySAM Battwatts module</span>
<span class="sd">    costs: Dictionary with system costs</span>
<span class="sd">    agent: pd.Series with agent attirbutes</span>
<span class="sd">    rate_switch_table: pd.DataFrame with details on how rates will switch with DG/storage adoption</span>
<span class="sd">    en_batt: Enable battery</span>
<span class="sd">    batt_simple_dispatch: batt.Battery.batt_simple_dispatch</span>
<span class="sd">        - batt_simple_dispatch = 0 (peak shaving look ahead)</span>
<span class="sd">        - batt_simple_dispatch = 1 (peak shaving look behind)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    -loan.Outputs.npv: the negative net present value of system + storage to be optimized for system sizing</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">inv_eff</span> <span class="o">=</span> <span class="mf">0.96</span>  <span class="c1"># default SAM inverter efficiency for PV</span>
    <span class="n">gen_hourly</span> <span class="o">=</span> <span class="n">pv</span><span class="p">[</span><span class="s1">&#39;generation_hourly&#39;</span><span class="p">]</span>
    <span class="n">load_hourly</span> <span class="o">=</span> <span class="n">pv</span><span class="p">[</span><span class="s1">&#39;consumption_hourly&#39;</span><span class="p">]</span>  <span class="c1"># same field as &#39;load_kwh_per_customer_in_bin_initial&#39; when summed</span>

    <span class="n">dc</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="n">kw</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen_hourly</span><span class="p">]</span> <span class="c1"># W</span>
    <span class="n">ac</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">inv_eff</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dc</span><span class="p">]</span> <span class="c1"># W</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">1000</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ac</span><span class="p">]</span> <span class="c1"># W to kW</span>
    
    <span class="c1"># Set up battery, with system generation conditional on the battery generation being included</span>
    <span class="k">if</span> <span class="n">en_batt</span><span class="p">:</span>

        <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span>
        <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">ac</span> <span class="o">=</span> <span class="n">ac</span>
        <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_enable</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_chemistry</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># default value is 1: li ion for residential</span>
        <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_dispatch</span> <span class="o">=</span> <span class="n">batt_simple_dispatch</span>
        <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_meter_position</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># default value</span>
        <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">inverter_efficiency</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># recommended by Darice for dc-connected</span>
        <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">load</span> <span class="o">=</span> <span class="n">load_hourly</span>

        <span class="c1"># PV to Battery ratio (kW) - From Ashreeta, 02/08/2020</span>
        <span class="n">pv_to_batt_ratio</span> <span class="o">=</span> <span class="mf">1.31372</span>
        <span class="n">batt_capacity_to_power_ratio</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># hours of operation</span>
        
        <span class="n">desired_size</span> <span class="o">=</span> <span class="n">kw</span> <span class="o">/</span> <span class="n">pv_to_batt_ratio</span> <span class="c1"># Default SAM value for residential systems is 10 </span>
        <span class="n">desired_power</span> <span class="o">=</span> <span class="n">desired_size</span> <span class="o">/</span> <span class="n">batt_capacity_to_power_ratio</span>

        <span class="n">batt_inputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;batt_chem&#39;</span><span class="p">:</span> <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_chemistry</span><span class="p">,</span>
            <span class="s1">&#39;batt_Qfull&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span> <span class="c1"># default SAM value</span>
            <span class="s1">&#39;batt_Vnom_default&#39;</span><span class="p">:</span> <span class="mf">3.6</span><span class="p">,</span> <span class="c1"># default SAM value</span>
            <span class="s1">&#39;batt_ac_or_dc&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># dc-connected</span>
            <span class="s1">&#39;desired_power&#39;</span><span class="p">:</span> <span class="n">desired_power</span><span class="p">,</span>
            <span class="s1">&#39;desired_capacity&#39;</span><span class="p">:</span> <span class="n">desired_size</span><span class="p">,</span>
            <span class="s1">&#39;desired_voltage&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s1">&#39;size_by_ac_not_dc&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># dc-connected</span>
            <span class="s1">&#39;inverter_eff&#39;</span><span class="p">:</span> <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">inverter_efficiency</span>
            <span class="c1"># &#39;batt_dc_dc_efficiency&#39;: (optional)</span>
        <span class="p">}</span>

        <span class="c1"># Default values for lead acid batteries</span>
        <span class="k">if</span> <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_chemistry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">batt_inputs</span><span class="p">[</span><span class="s1">&#39;LeadAcid_q10&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">93.2</span>
            <span class="n">batt_inputs</span><span class="p">[</span><span class="s1">&#39;LeadAcid_q20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">batt_inputs</span><span class="p">[</span><span class="s1">&#39;LeadAcid_qn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">58.12</span>
            <span class="c1"># batt_inputs[&#39;LeadAcid_tn&#39;]: (optional)</span>

        <span class="n">batt_outputs</span> <span class="o">=</span> <span class="n">batt_tools</span><span class="o">.</span><span class="n">size_li_ion_battery</span><span class="p">(</span><span class="n">batt_inputs</span><span class="p">)</span>

        <span class="n">computed_size</span> <span class="o">=</span> <span class="n">batt_outputs</span><span class="p">[</span><span class="s1">&#39;batt_computed_bank_capacity&#39;</span><span class="p">]</span>
        <span class="n">computed_power</span> <span class="o">=</span> <span class="n">batt_outputs</span><span class="p">[</span><span class="s1">&#39;batt_power_discharge_max_kwdc&#39;</span><span class="p">]</span>

        <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_kwh</span> <span class="o">=</span> <span class="n">computed_size</span>
        <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_kw</span> <span class="o">=</span> <span class="n">computed_power</span>

        <span class="n">batt</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>


        <span class="c1"># apply storage rate switch if computed_size is nonzero</span>
        <span class="k">if</span> <span class="n">computed_size</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">agent</span><span class="p">,</span> <span class="n">one_time_charge</span> <span class="o">=</span> <span class="n">agent_mutation</span><span class="o">.</span><span class="n">elec</span><span class="o">.</span><span class="n">apply_rate_switch</span><span class="p">(</span><span class="n">rate_switch_table</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">computed_size</span><span class="p">,</span> <span class="n">tech</span><span class="o">=</span><span class="s1">&#39;storage&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">one_time_charge</span> <span class="o">=</span> <span class="mf">0.</span>
              
        <span class="c1"># declare value for net billing sell rate</span>
        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;compensation_style&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">net_billing_sell_rate</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">net_billing_sell_rate</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;wholesale_elec_price_dollars_per_kwh&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;elec_price_multiplier&#39;</span><span class="p">]</span>
        
        <span class="n">utilityrate</span> <span class="o">=</span> <span class="n">process_tariff</span><span class="p">(</span><span class="n">utilityrate</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;tariff_dict&#39;</span><span class="p">],</span> <span class="n">net_billing_sell_rate</span><span class="p">)</span>
        <span class="n">utilityrate</span><span class="o">.</span><span class="n">SystemOutput</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="n">batt</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">gen</span>

        <span class="n">loan</span><span class="o">.</span><span class="n">BatterySystem</span><span class="o">.</span><span class="n">en_batt</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">BatterySystem</span><span class="o">.</span><span class="n">batt_computed_bank_capacity</span> <span class="o">=</span> <span class="n">batt</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">batt_bank_installed_capacity</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">BatterySystem</span><span class="o">.</span><span class="n">batt_bank_replacement</span> <span class="o">=</span> <span class="n">batt</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">batt_bank_replacement</span>
        
        <span class="c1"># #loan.BatterySystem.battery_per_kWh = costs[&#39;batt_capex_per_kwh&#39;]</span>
        
        <span class="c1"># # Battery capacity-based System Costs amount [$/kWcap]</span>
        <span class="c1"># loan.SystemCosts.om_capacity1 = [costs[&#39;batt_om_per_kw&#39;]]</span>

        <span class="c1"># # Battery production-based System Costs amount [$/MWh]</span>
        <span class="c1"># # loan.SystemCosts.om_production1 = [costs[&#39;batt_om_per_kwh&#39;] * 1000]</span>
        <span class="c1"># loan.SystemCosts.om_production1 = [costs[&#39;batt_om_per_kwh&#39;] * 1000.]</span>



        <span class="c1"># specify number of O&amp;M types (1 = PV+batt)</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">add_om_num_types</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># if PV system size nonzero, specify combined O&amp;M costs; otherwise, specify standalone O&amp;M costs</span>
        <span class="k">if</span> <span class="n">kw</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">BatterySystem</span><span class="o">.</span><span class="n">battery_per_kWh</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kwh_combined&#39;</span><span class="p">]</span>
            
            <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_capacity</span> <span class="o">=</span> <span class="p">[</span><span class="n">costs</span><span class="p">[</span><span class="s1">&#39;system_om_per_kw_combined&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;system_variable_om_per_kw_combined&#39;</span><span class="p">]]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_capacity1</span> <span class="o">=</span> <span class="p">[</span><span class="n">costs</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kw_combined&#39;</span><span class="p">]]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_production1</span> <span class="o">=</span> <span class="p">[</span><span class="n">costs</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kwh_combined&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_replacement_cost1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
            
            <span class="n">system_costs</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;system_capex_per_kw_combined&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">kw</span>

            <span class="c1"># specify linear constant adder for PV+batt (combined) system</span>
            <span class="n">linear_constant</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;linear_constant_combined&#39;</span><span class="p">]</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">BatterySystem</span><span class="o">.</span><span class="n">battery_per_kWh</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kwh&#39;</span><span class="p">]</span>
            
            <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_capacity</span> <span class="o">=</span> <span class="p">[</span><span class="n">costs</span><span class="p">[</span><span class="s1">&#39;system_om_per_kw&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;system_variable_om_per_kw&#39;</span><span class="p">]]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_capacity1</span> <span class="o">=</span> <span class="p">[</span><span class="n">costs</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kw&#39;</span><span class="p">]]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_production1</span> <span class="o">=</span> <span class="p">[</span><span class="n">costs</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kwh&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_replacement_cost1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
            
            <span class="n">system_costs</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;system_capex_per_kw&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">kw</span>

            <span class="c1"># specify linear constant adder for standalone battery system</span>
            <span class="n">linear_constant</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;linear_constant&#39;</span><span class="p">]</span>

        
        <span class="c1"># Battery capacity for System Costs values [kW]</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_capacity1_nameplate</span> <span class="o">=</span> <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_kw</span>
        <span class="c1"># Battery production for System Costs values [kWh]</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_production1_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_kwh</span><span class="p">]</span> <span class="c1"># should this be batt.Outputs.batt_bank_installed_capacity?</span>

        <span class="c1">#batt_costs = (costs[&#39;batt_capex_per_kw&#39;]*batt.Battery.batt_simple_kw) + (costs[&#39;batt_capex_per_kwh&#39;] * batt.Battery.batt_simple_kwh)</span>
        <span class="n">batt_costs</span> <span class="o">=</span> <span class="p">((</span><span class="n">costs</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kw_combined&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_kw</span><span class="p">)</span> <span class="o">+</span> 
                      <span class="p">(</span><span class="n">costs</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kwh_combined&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_kwh</span><span class="p">))</span>

        <span class="n">value_of_resiliency</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;value_of_resiliency_usd&#39;</span><span class="p">]</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_enable</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">BatterySystem</span><span class="o">.</span><span class="n">en_batt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">computed_power</span> <span class="o">=</span> <span class="n">computed_size</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># apply solar rate switch if computed_size is nonzero</span>
        <span class="k">if</span> <span class="n">kw</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">agent</span><span class="p">,</span> <span class="n">one_time_charge</span> <span class="o">=</span> <span class="n">agent_mutation</span><span class="o">.</span><span class="n">elec</span><span class="o">.</span><span class="n">apply_rate_switch</span><span class="p">(</span><span class="n">rate_switch_table</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">tech</span><span class="o">=</span><span class="s1">&#39;solar&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">one_time_charge</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># declare value for net billing sell rate</span>
        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;compensation_style&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">net_billing_sell_rate</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">net_billing_sell_rate</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;wholesale_elec_price_dollars_per_kwh&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;elec_price_multiplier&#39;</span><span class="p">]</span>
        
        <span class="n">utilityrate</span> <span class="o">=</span> <span class="n">process_tariff</span><span class="p">(</span><span class="n">utilityrate</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;tariff_dict&#39;</span><span class="p">],</span> <span class="n">net_billing_sell_rate</span><span class="p">)</span>
        <span class="n">utilityrate</span><span class="o">.</span><span class="n">SystemOutput</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="n">gen</span>

        <span class="n">loan</span><span class="o">.</span><span class="n">BatterySystem</span><span class="o">.</span><span class="n">en_batt</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># specify number of O&amp;M types (0 = PV only)</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">add_om_num_types</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># since battery system size is zero, specify standalone PV O&amp;M costs</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_capacity</span> <span class="o">=</span> <span class="p">[</span><span class="n">costs</span><span class="p">[</span><span class="s1">&#39;system_om_per_kw&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;system_variable_om_per_kw&#39;</span><span class="p">]]</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">om_replacement_cost1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
        
        <span class="n">system_costs</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;system_capex_per_kw&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">kw</span>

        <span class="n">batt_costs</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># linear constant for standalone PV system is 0.</span>
        <span class="n">linear_constant</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">value_of_resiliency</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># Execute utility rate module</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">Load</span><span class="o">.</span><span class="n">load</span> <span class="o">=</span> <span class="n">load_hourly</span>
    <span class="c1">#utilityrate.ElectricityRates.ur_metering_option = ur_metering_option</span>
    
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="n">loan</span> <span class="o">=</span> <span class="n">process_incentives</span><span class="p">(</span><span class="n">loan</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">computed_power</span><span class="p">,</span> <span class="n">computed_size</span><span class="p">,</span> <span class="n">gen_hourly</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>
    
    <span class="c1"># Specify final Cashloan parameters</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">system_capacity</span> <span class="o">=</span> <span class="n">kw</span>
    <span class="c1"># Add value_of_resiliency -- should only apply from year 1 onwards, not to year 0</span>
    <span class="n">annual_energy_value</span> <span class="o">=</span> <span class="p">([</span><span class="n">utilityrate</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">annual_energy_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> 
                           <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">value_of_resiliency</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">utilityrate</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">annual_energy_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">SystemOutput</span><span class="o">.</span><span class="n">annual_energy_value</span> <span class="o">=</span> <span class="n">annual_energy_value</span> 
    <span class="n">loan</span><span class="o">.</span><span class="n">SystemOutput</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="n">utilityrate</span><span class="o">.</span><span class="n">SystemOutput</span><span class="o">.</span><span class="n">gen</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">ThirdPartyOwnership</span><span class="o">.</span><span class="n">elec_cost_with_system</span> <span class="o">=</span> <span class="n">utilityrate</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">elec_cost_with_system</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">ThirdPartyOwnership</span><span class="o">.</span><span class="n">elec_cost_without_system</span> <span class="o">=</span> <span class="n">utilityrate</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">elec_cost_without_system</span>

    <span class="c1"># Calculate system costs</span>
    <span class="c1">#system_costs = costs[&#39;system_capex_per_kw&#39;] * kw</span>
    <span class="n">direct_costs</span> <span class="o">=</span> <span class="p">(</span><span class="n">system_costs</span> <span class="o">+</span> <span class="n">batt_costs</span><span class="p">)</span> <span class="o">*</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;cap_cost_multiplier&#39;</span><span class="p">]</span>

    <span class="n">sales_tax</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">SystemCosts</span><span class="o">.</span><span class="n">total_installed_cost</span> <span class="o">=</span> <span class="n">direct_costs</span> <span class="o">+</span> <span class="n">linear_constant</span> <span class="o">+</span> <span class="n">sales_tax</span> <span class="o">+</span> <span class="n">one_time_charge</span>
    
    <span class="c1"># Execute financial module </span>
    <span class="n">loan</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">loan</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">npv</span></div>


<div class="viewcode-block" id="calc_system_size_and_performance"><a class="viewcode-back" href="../../api.html#python.financial_functions.calc_system_size_and_performance">[docs]</a><span class="k">def</span> <span class="nf">calc_system_size_and_performance</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">rate_switch_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the optimal system and battery size and generation profile, and resulting bill savings and financial metrics.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    agent : &#39;pd.df&#39;</span>
<span class="sd">        individual agent object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    agent: &#39;pd.df&#39;</span>
<span class="sd">        Adds several features to the agent dataframe:</span>

<span class="sd">        - agent_id</span>
<span class="sd">        - system_kw - system capacity selected by agent</span>
<span class="sd">        - batt_kw - battery capacity selected by agent</span>
<span class="sd">        - batt_kwh - battery energy capacity</span>
<span class="sd">        - npv - net present value of system + storage</span>
<span class="sd">        - cash_flow  - array of annual cash flows from system adoption</span>
<span class="sd">        - batt_dispatch_profile - array of hourly battery dispatch</span>
<span class="sd">        - annual_energy_production_kwh - annual energy production (kwh) of system</span>
<span class="sd">        - naep - normalized annual energy production (kwh/kW) of system</span>
<span class="sd">        - capacity_factor - annual capacity factor</span>
<span class="sd">        - first_year_elec_bill_with_system - first year electricity bill with adopted system ($/yr)</span>
<span class="sd">        - first_year_elec_bill_savings - first year electricity bill savings with adopted system ($/yr)</span>
<span class="sd">        - first_year_elec_bill_savings_frac - fraction of savings on electricity bill in first year of system adoption</span>
<span class="sd">        - max_system_kw - maximum system size allowed as constrained by roof size or not exceeding annual consumption </span>
<span class="sd">        - first_year_elec_bill_without_system - first year electricity bill without adopted system ($/yr)</span>
<span class="sd">        - avg_elec_price_cents_per_kwh - first year electricity price (c/kwh)</span>
<span class="sd">        - cbi - ndarray of capacity-based incentives applicable to agent</span>
<span class="sd">        - ibi - ndarray of investment-based incentives applicable to agent</span>
<span class="sd">        - pbi - ndarray of performance-based incentives applicable to agent</span>
<span class="sd">        - cash_incentives - ndarray of cash-based incentives applicable to agent</span>
<span class="sd">        - export_tariff_result - summary of structure of retail tariff applied to agent</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1"># Initialize new DB connection    </span>
    <span class="n">model_settings</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">init_model_settings</span><span class="p">()</span>
    <span class="n">con</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">utilfunc</span><span class="o">.</span><span class="n">make_con</span><span class="p">(</span><span class="n">model_settings</span><span class="o">.</span><span class="n">pg_conn_string</span><span class="p">,</span> <span class="n">model_settings</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>

    <span class="c1"># PV</span>
    <span class="n">pv</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">load_profile_df</span> <span class="o">=</span> <span class="n">agent_mutation</span><span class="o">.</span><span class="n">elec</span><span class="o">.</span><span class="n">get_and_apply_agent_load_profiles</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>

    <span class="n">pv</span><span class="p">[</span><span class="s1">&#39;consumption_hourly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">load_profile_df</span><span class="p">[</span><span class="s1">&#39;consumption_hourly&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">load_profile_df</span>

    <span class="c1"># Using the scale offset factor of 1E6 for capacity factors</span>
    <span class="n">norm_scaled_pv_cf_profiles_df</span> <span class="o">=</span> <span class="n">agent_mutation</span><span class="o">.</span><span class="n">elec</span><span class="o">.</span><span class="n">get_and_apply_normalized_hourly_resource_solar</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>
    <span class="n">pv</span><span class="p">[</span><span class="s1">&#39;generation_hourly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">norm_scaled_pv_cf_profiles_df</span><span class="p">[</span><span class="s1">&#39;solar_cf_profile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span>  <span class="mf">1e6</span>
    <span class="k">del</span> <span class="n">norm_scaled_pv_cf_profiles_df</span>
    
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;naep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pv</span><span class="p">[</span><span class="s1">&#39;generation_hourly&#39;</span><span class="p">]))</span>

    <span class="c1"># Battwatts</span>
    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;sector_abbr&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;res&#39;</span><span class="p">:</span>
        <span class="n">batt</span> <span class="o">=</span> <span class="n">battery</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;PVWattsBatteryResidential&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">batt</span> <span class="o">=</span> <span class="n">battery</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;PVWattsBatteryCommercial&quot;</span><span class="p">)</span>

    <span class="c1"># Instantiate utilityrate5 model based on agent sector</span>
    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;sector_abbr&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;res&#39;</span><span class="p">:</span>
        <span class="n">utilityrate</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;PVWattsBatteryResidential&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">utilityrate</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;PVWattsBatteryCommercial&quot;</span><span class="p">)</span>
    <span class="n">tariff_dict</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;tariff_dict&#39;</span><span class="p">]</span>
    

    <span class="c1">######################################</span>
    <span class="c1">###--------- UTILITYRATE5 ---------###</span>
    <span class="c1">###--- SYSTEM LIFETIME SETTINGS ---###</span>
    <span class="c1">######################################</span>
    
    <span class="c1"># Inflation rate [%]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">Lifetime</span><span class="o">.</span><span class="n">inflation_rate</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;inflation_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="c1"># Number of years in analysis [years]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">Lifetime</span><span class="o">.</span><span class="n">analysis_period</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;economic_lifetime_yrs&#39;</span><span class="p">]</span>
    
    <span class="c1"># Lifetime hourly system outputs [0/1]; Options: 0=hourly first year,1=hourly lifetime</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">Lifetime</span><span class="o">.</span><span class="n">system_use_lifetime_output</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="c1">######################################</span>
    <span class="c1">###--------- UTILITYRATE5 ---------###</span>
    <span class="c1">###---- DEGRADATION/ESCALATION ----###</span>
    <span class="c1">######################################</span>
    
    <span class="c1"># Annual energy degradation [%]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">SystemOutput</span><span class="o">.</span><span class="n">degradation</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;pv_degradation_factor&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">]</span> <span class="c1"># convert decimal to %</span>

    <span class="c1"># old method</span>
    <span class="c1"># degradation = [agent.loc[&#39;pv_degradation_factor&#39;] * 100] # convert decimal to %</span>
    <span class="c1"># utilityrate.SystemOutput.degradation = degradation</span>

    <span class="c1"># Annual electricity rate escalation [%/year]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">rate_escalation</span>  <span class="o">=</span> <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;elec_price_escalator&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">]</span> <span class="c1"># convert decimal to %</span>
    
    
    <span class="c1">######################################</span>
    <span class="c1">###--------- UTILITYRATE5 ---------###</span>
    <span class="c1">###---- NET METERING SETTINGS -----###</span>
    <span class="c1">######################################</span>
    
    <span class="c1"># Dictionary to map dGen compensation styles to PySAM options</span>
    <span class="n">nem_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;net metering&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;net billing&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;buy all sell all&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
    <span class="c1"># Metering options [0=net energy metering,1=net energy metering with $ credits,2=net billing,3=net billing with carryover to next month,4=buy all - sell all]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_metering_option</span> <span class="o">=</span> <span class="n">nem_options</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;compensation_style&#39;</span><span class="p">]]</span>
    <span class="c1"># Year end sell rate [$/kWh]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_nm_yearend_sell_rate</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;wholesale_elec_price_dollars_per_kwh&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;elec_price_multiplier&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;compensation_style&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">net_billing_sell_rate</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">net_billing_sell_rate</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;wholesale_elec_price_dollars_per_kwh&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;elec_price_multiplier&#39;</span><span class="p">]</span>
    
    
    <span class="c1"># ######################################</span>
    <span class="c1"># ###--------- UTILITYRATE5 ---------###</span>
    <span class="c1"># ###--- FIXED AND ANNUAL CHARGES ---###</span>
    <span class="c1"># ######################################</span>
    
    <span class="c1"># # Monthly fixed charge [$]</span>
    <span class="c1"># utilityrate.ElectricityRates.ur_monthly_fixed_charge = tariff_dict[&#39;fixed_charge&#39;]</span>
    <span class="c1"># # Annual minimum charge [$]</span>
    <span class="c1"># utilityrate.ElectricityRates.ur_annual_min_charge = 0. # not currently tracked in URDB rate attribute downloads</span>
    <span class="c1"># # Monthly minimum charge [$]</span>
    <span class="c1"># utilityrate.ElectricityRates.ur_monthly_min_charge = 0. # not currently tracked in URDB rate attribute downloads</span>
    
    
    <span class="c1"># ######################################</span>
    <span class="c1"># ###--------- UTILITYRATE5 ---------###</span>
    <span class="c1"># ###-------- DEMAND CHARGES --------###</span>
    <span class="c1"># ######################################</span>
    
    <span class="c1"># # Enable demand charge</span>
    <span class="c1"># utilityrate.ElectricityRates.ur_dc_enable = (tariff_dict[&#39;d_flat_exists&#39;]) | (tariff_dict[&#39;d_tou_exists&#39;])</span>
    
    <span class="c1"># if utilityrate.ElectricityRates.ur_dc_enable:</span>
    
    <span class="c1">#     if tariff_dict[&#39;d_flat_exists&#39;]:</span>
            
    <span class="c1">#         # Reformat demand charge table from dGen format</span>
    <span class="c1">#         n_periods = len(tariff_dict[&#39;d_flat_levels&#39;][0])</span>
    <span class="c1">#         n_tiers = len(tariff_dict[&#39;d_flat_levels&#39;])</span>
    <span class="c1">#         ur_dc_flat_mat = []</span>
    <span class="c1">#         for period in range(n_periods):</span>
    <span class="c1">#             for tier in range(n_tiers):</span>
    <span class="c1">#                 row = [period, tier+1, tariff_dict[&#39;d_flat_levels&#39;][tier][period], tariff_dict[&#39;d_flat_prices&#39;][tier][period]]</span>
    <span class="c1">#                 ur_dc_flat_mat.append(row)</span>
            
    <span class="c1">#         # Demand rates (flat) table</span>
    <span class="c1">#         utilityrate.ElectricityRates.ur_dc_flat_mat = ur_dc_flat_mat</span>
        
        
    <span class="c1">#     if tariff_dict[&#39;d_tou_exists&#39;]:</span>
            
    <span class="c1">#         # Reformat demand charge table from dGen format</span>
    <span class="c1">#         n_periods = len(tariff_dict[&#39;d_tou_levels&#39;][0])</span>
    <span class="c1">#         n_tiers = len(tariff_dict[&#39;d_tou_levels&#39;])</span>
    <span class="c1">#         ur_dc_tou_mat = []</span>
    <span class="c1">#         for period in range(n_periods):</span>
    <span class="c1">#             for tier in range(n_tiers):</span>
    <span class="c1">#                 row = [period+1, tier+1, tariff_dict[&#39;d_tou_levels&#39;][tier][period], tariff_dict[&#39;d_tou_prices&#39;][tier][period]]</span>
    <span class="c1">#                 ur_dc_tou_mat.append(row)</span>
            
    <span class="c1">#         # Demand rates (TOU) table</span>
    <span class="c1">#         utilityrate.ElectricityRates.ur_dc_tou_mat = ur_dc_tou_mat</span>
    
    
    <span class="c1">#     # Reformat 12x24 tables - original are indexed to 0, PySAM needs index starting at 1</span>
    <span class="c1">#     d_wkday_12by24 = []</span>
    <span class="c1">#     for m in range(len(tariff_dict[&#39;d_wkday_12by24&#39;])):</span>
    <span class="c1">#         row = [x+1 for x in tariff_dict[&#39;d_wkday_12by24&#39;][m]]</span>
    <span class="c1">#         d_wkday_12by24.append(row)</span>
            
    <span class="c1">#     d_wkend_12by24 = []</span>
    <span class="c1">#     for m in range(len(tariff_dict[&#39;d_wkend_12by24&#39;])):</span>
    <span class="c1">#         row = [x+1 for x in tariff_dict[&#39;d_wkend_12by24&#39;][m]]</span>
    <span class="c1">#         d_wkend_12by24.append(row)</span>

    <span class="c1">#     # Demand charge weekday schedule</span>
    <span class="c1">#     utilityrate.ElectricityRates.ur_dc_sched_weekday = d_wkday_12by24</span>
    <span class="c1">#     # Demand charge weekend schedule</span>
    <span class="c1">#     utilityrate.ElectricityRates.ur_dc_sched_weekend = d_wkend_12by24</span>
    
    
    <span class="c1"># ######################################</span>
    <span class="c1"># ###--------- UTILITYRATE5 ---------###</span>
    <span class="c1"># ###-------- ENERGY CHARGES --------###</span>
    <span class="c1"># ######################################</span>
    
    <span class="c1"># if tariff_dict[&#39;e_exists&#39;]:</span>
        
    <span class="c1">#     # Dictionary to map dGen max usage units to PySAM options</span>
    <span class="c1">#     max_usage_dict = {&#39;kWh&#39;:0, &#39;kWh/kW&#39;:1, &#39;kWh daily&#39;:2, &#39;kWh/kW daily&#39;:3}</span>

    <span class="c1">#     # If max usage units are &#39;kWh daily&#39;, divide max usage by 30 -- rate download procedure converts daily to monthly</span>
    <span class="c1">#     modifier = 30. if tariff_dict[&#39;energy_rate_unit&#39;] == &#39;kWh daily&#39; else 1.</span>
        
    <span class="c1">#     # Reformat energy charge table from dGen format</span>
    <span class="c1">#     n_periods = len(tariff_dict[&#39;e_levels&#39;][0])</span>
    <span class="c1">#     n_tiers = len(tariff_dict[&#39;e_levels&#39;])</span>
    <span class="c1">#     ur_ec_tou_mat = []</span>
    <span class="c1">#     for period in range(n_periods):</span>
    <span class="c1">#         for tier in range(n_tiers):</span>
    <span class="c1">#             row = [period+1, tier+1, tariff_dict[&#39;e_levels&#39;][tier][period]/modifier,</span>
    <span class="c1">#              max_usage_dict[tariff_dict[&#39;energy_rate_unit&#39;]], tariff_dict[&#39;e_prices&#39;][tier][period], net_billing_sell_rate]</span>
    <span class="c1">#             ur_ec_tou_mat.append(row)</span>
        
    <span class="c1">#     # Energy rates table</span>
    <span class="c1">#     utilityrate.ElectricityRates.ur_ec_tou_mat = ur_ec_tou_mat</span>
        
    <span class="c1">#     # Reformat 12x24 tables - original are indexed to 0, PySAM needs index starting at 1</span>
    <span class="c1">#     e_wkday_12by24 = []</span>
    <span class="c1">#     for m in range(len(tariff_dict[&#39;e_wkday_12by24&#39;])):</span>
    <span class="c1">#         row = [x+1 for x in tariff_dict[&#39;e_wkday_12by24&#39;][m]]</span>
    <span class="c1">#         e_wkday_12by24.append(row)</span>
            
    <span class="c1">#     e_wkend_12by24 = []</span>
    <span class="c1">#     for m in range(len(tariff_dict[&#39;e_wkend_12by24&#39;])):</span>
    <span class="c1">#         row = [x+1 for x in tariff_dict[&#39;e_wkend_12by24&#39;][m]]</span>
    <span class="c1">#         e_wkend_12by24.append(row)</span>
        
    <span class="c1">#     # Energy charge weekday schedule</span>
    <span class="c1">#     utilityrate.ElectricityRates.ur_ec_sched_weekday = e_wkday_12by24</span>
    <span class="c1">#     # Energy charge weekend schedule</span>
    <span class="c1">#     utilityrate.ElectricityRates.ur_ec_sched_weekend = e_wkend_12by24</span>
        
    
    <span class="c1">######################################</span>
    <span class="c1">###--------- UTILITYRATE5 ---------###</span>
    <span class="c1">###-------- BUY/SELL RATES --------###</span>
    <span class="c1">######################################</span>
    
    <span class="c1"># Enable time step sell rates [0/1]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_en_ts_sell_rate</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Time step sell rates [0/1]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_ts_sell_rate</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
    
    <span class="c1"># Set sell rate equal to buy rate [0/1]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_sell_eq_buy</span> <span class="o">=</span> <span class="mi">0</span>
    
    
    <span class="c1">######################################</span>
    <span class="c1">###--------- UTILITYRATE5 ---------###</span>
    <span class="c1">###-------- MISC. SETTINGS --------###</span>
    <span class="c1">######################################</span>
    
    <span class="c1"># Use single monthly peak for TOU demand charge; options: 0=use TOU peak,1=use flat peak</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">TOU_demand_single_peak</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># ?</span>
    
    <span class="c1"># Optionally enable/disable electricity_rate [years]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">en_electricity_rates</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1">######################################</span>
    <span class="c1">###--------- UTILITYRATE5 ---------###</span>
    <span class="c1">###----- TARIFF RESTRUCTURING -----###</span>
    <span class="c1">######################################</span>
    <span class="n">utilityrate</span> <span class="o">=</span> <span class="n">process_tariff</span><span class="p">(</span><span class="n">utilityrate</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;tariff_dict&#39;</span><span class="p">],</span> <span class="n">net_billing_sell_rate</span><span class="p">)</span>
    
    
    <span class="c1">######################################</span>
    <span class="c1">###----------- CASHLOAN -----------###</span>
    <span class="c1">###----- FINANCIAL PARAMETERS -----###</span>
    <span class="c1">######################################</span>

    <span class="c1"># Initiate cashloan model and set market-specific variables</span>
    <span class="c1"># Assume res agents do not evaluate depreciation at all</span>
    <span class="c1"># Assume non-res agents only evaluate federal depreciation (not state)</span>
    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;sector_abbr&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;res&#39;</span><span class="p">:</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="n">cashloan</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;PVWattsBatteryResidential&quot;</span><span class="p">)</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">market</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">loan</span> <span class="o">=</span> <span class="n">cashloan</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;PVWattsBatteryCommercial&quot;</span><span class="p">)</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">market</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">analysis_period</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;economic_lifetime_yrs&#39;</span><span class="p">]</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">debt_fraction</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;down_payment_fraction&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">federal_tax_rate</span> <span class="o">=</span> <span class="p">[(</span><span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;tax_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">]</span> <span class="c1"># SAM default</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">inflation_rate</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;inflation_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">insurance_rate</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">loan_rate</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;loan_interest_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>    
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">loan_term</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;loan_term_yrs&#39;</span><span class="p">]</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">mortgage</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># default value - standard loan (no mortgage)</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">prop_tax_assessed_decline</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># PySAM default</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">prop_tax_cost_assessed_percent</span> <span class="o">=</span> <span class="mi">95</span> <span class="c1"># PySAM default</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">property_tax_rate</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># PySAM default</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">real_discount_rate</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;real_discount_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">salvage_percentage</span> <span class="o">=</span> <span class="mi">0</span>    
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">state_tax_rate</span> <span class="o">=</span> <span class="p">[(</span><span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;tax_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">]</span> <span class="c1"># SAM default</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">FinancialParameters</span><span class="o">.</span><span class="n">system_heat_rate</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="c1">######################################</span>
    <span class="c1">###----------- CASHLOAN -----------###</span>
    <span class="c1">###--------- SYSTEM COSTS ---------###</span>
    <span class="c1">######################################</span>
    
    <span class="c1"># System costs that are input to loan.SystemCosts will depend on system configuration (PV, batt, PV+batt)</span>
    <span class="c1"># and are therefore specified in calc_system_performance()</span>

    <span class="n">system_costs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;system_capex_per_kw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;system_capex_per_kw&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;system_om_per_kw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;system_om_per_kw&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;system_variable_om_per_kw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;system_variable_om_per_kw&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;cap_cost_multiplier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;cap_cost_multiplier&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kw&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kwh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kwh&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kw&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kwh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kwh&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;linear_constant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;linear_constant&#39;</span><span class="p">]</span>

    <span class="c1"># costs for PV+batt configuration are distinct from standalone techs</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;system_capex_per_kw_combined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;system_capex_per_kw_combined&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;system_om_per_kw_combined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;system_om_per_kw&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;system_variable_om_per_kw_combined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;system_variable_om_per_kw&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kw_combined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kw_combined&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kwh_combined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_capex_per_kwh_combined&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kw_combined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kw_combined&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kwh_combined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_om_per_kwh_combined&#39;</span><span class="p">]</span>
    <span class="n">system_costs</span><span class="p">[</span><span class="s1">&#39;linear_constant_combined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;linear_constant_combined&#39;</span><span class="p">]</span>
    


    <span class="c1">######################################</span>
    <span class="c1">###----------- CASHLOAN -----------###</span>
    <span class="c1">###---- DEPRECIATION PARAMETERS ---###</span>
    <span class="c1">######################################</span>
    
    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;sector_abbr&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;res&#39;</span><span class="p">:</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">Depreciation</span><span class="o">.</span><span class="n">depr_fed_type</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">Depreciation</span><span class="o">.</span><span class="n">depr_sta_type</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">Depreciation</span><span class="o">.</span><span class="n">depr_fed_type</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">Depreciation</span><span class="o">.</span><span class="n">depr_sta_type</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1">######################################</span>
    <span class="c1">###----------- CASHLOAN -----------###</span>
    <span class="c1">###----- TAX CREDIT INCENTIVES ----###</span>
    <span class="c1">######################################</span>
    
    <span class="n">loan</span><span class="o">.</span><span class="n">TaxCreditIncentives</span><span class="o">.</span><span class="n">itc_fed_percent</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;itc_fraction_of_capex&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="c1">######################################</span>
    <span class="c1">###----------- CASHLOAN -----------###</span>
    <span class="c1">###-------- BATTERY SYSTEM --------###</span>
    <span class="c1">######################################</span>
    
    <span class="n">loan</span><span class="o">.</span><span class="n">BatterySystem</span><span class="o">.</span><span class="n">batt_replacement_option</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># user schedule</span>
    
    <span class="n">batt_replacement_schedule</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_lifetime_yrs&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">loan</span><span class="o">.</span><span class="n">BatterySystem</span><span class="o">.</span><span class="n">batt_replacement_schedule</span> <span class="o">=</span> <span class="n">batt_replacement_schedule</span>
    
    
    <span class="c1">######################################</span>
    <span class="c1">###----------- CASHLOAN -----------###</span>
    <span class="c1">###-------- SYSTEM OUTPUT ---------###</span>
    <span class="c1">######################################</span>
    
    <span class="n">loan</span><span class="o">.</span><span class="n">SystemOutput</span><span class="o">.</span><span class="n">degradation</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;pv_degradation_factor&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">]</span>
    
    
    <span class="c1">######################################</span>
    <span class="c1">###----------- CASHLOAN -----------###</span>
    <span class="c1">###----------- LIFETIME -----------###</span>
    <span class="c1">######################################</span>
    
    <span class="n">loan</span><span class="o">.</span><span class="n">Lifetime</span><span class="o">.</span><span class="n">system_use_lifetime_output</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">###################################### </span>
    <span class="c1">###-------- SYSTEM SIZING ---------### </span>
    <span class="c1">######################################</span>

    
    <span class="c1"># From dGen - calc_system_size_and_financial_performance()</span>
    <span class="n">max_size_load</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;load_kwh_per_customer_in_bin&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;naep&#39;</span><span class="p">]</span>
    <span class="n">max_size_roof</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;developable_roof_sqft&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;pv_kw_per_sqft&#39;</span><span class="p">]</span>
    <span class="n">max_system_kw</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_size_load</span><span class="p">,</span> <span class="n">max_size_roof</span><span class="p">)</span>
    
    <span class="c1"># set tolerance for minimize_scalar based on max_system_kw value</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.25</span> <span class="o">*</span> <span class="n">max_system_kw</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="c1">#tol = 0.25 * max_system_kw</span>

    <span class="c1"># Calculate the PV system size that maximizes the agent&#39;s NPV, to a tolerance of 0.5 kW. </span>
    <span class="c1"># Note that the optimization is technically minimizing negative NPV</span>
    <span class="c1"># ! As is, because of the tolerance this function would not necessarily return a system size of 0 or max PV size if those are optimal</span>
    <span class="n">res_with_batt</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">calc_system_performance</span><span class="p">,</span>
                                             <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">utilityrate</span><span class="p">,</span> <span class="n">loan</span><span class="p">,</span> <span class="n">batt</span><span class="p">,</span> <span class="n">system_costs</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">rate_switch_table</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                             <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_system_kw</span><span class="p">),</span>
                                             <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;bounded&#39;</span><span class="p">,</span>
                                             <span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">)</span>

    <span class="c1"># PySAM Module outputs with battery</span>
    <span class="n">batt_loan_outputs</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
    <span class="n">batt_util_outputs</span> <span class="o">=</span> <span class="n">utilityrate</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
    <span class="n">batt_annual_energy_kwh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">utilityrate</span><span class="o">.</span><span class="n">SystemOutput</span><span class="o">.</span><span class="n">gen</span><span class="p">)</span>

    <span class="n">batt_kw</span> <span class="o">=</span> <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_kw</span>
    <span class="n">batt_kwh</span> <span class="o">=</span> <span class="n">batt</span><span class="o">.</span><span class="n">Battery</span><span class="o">.</span><span class="n">batt_simple_kwh</span>
    <span class="n">batt_dispatch_profile</span> <span class="o">=</span> <span class="n">batt</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">batt_power</span> 

    <span class="c1"># Run without battery</span>
    <span class="n">res_no_batt</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">calc_system_performance</span><span class="p">,</span> 
                                           <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">utilityrate</span><span class="p">,</span> <span class="n">loan</span><span class="p">,</span> <span class="n">batt</span><span class="p">,</span> <span class="n">system_costs</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">rate_switch_table</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                           <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_system_kw</span><span class="p">),</span>
                                           <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;bounded&#39;</span><span class="p">,</span>
                                           <span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">)</span>

    <span class="c1"># PySAM Module outputs without battery</span>
    <span class="n">no_batt_loan_outputs</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
    <span class="n">no_batt_util_outputs</span> <span class="o">=</span> <span class="n">utilityrate</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
    <span class="n">no_batt_annual_energy_kwh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">utilityrate</span><span class="o">.</span><span class="n">SystemOutput</span><span class="o">.</span><span class="n">gen</span><span class="p">)</span>

    <span class="c1"># Retrieve NPVs of system with batt and system without batt</span>
    <span class="n">npv_w_batt</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">]</span>
    <span class="n">npv_no_batt</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">]</span>

    <span class="c1"># Choose the system with the higher NPV</span>
    <span class="k">if</span> <span class="n">npv_w_batt</span> <span class="o">&gt;=</span> <span class="n">npv_no_batt</span><span class="p">:</span>
        <span class="n">system_kw</span> <span class="o">=</span> <span class="n">res_with_batt</span><span class="o">.</span><span class="n">x</span>
        <span class="n">annual_energy_production_kwh</span> <span class="o">=</span> <span class="n">batt_annual_energy_kwh</span>
        <span class="n">first_year_elec_bill_with_system</span> <span class="o">=</span> <span class="n">batt_util_outputs</span><span class="p">[</span><span class="s1">&#39;elec_cost_with_system_year1&#39;</span><span class="p">]</span>
        <span class="n">first_year_elec_bill_without_system</span> <span class="o">=</span> <span class="n">batt_util_outputs</span><span class="p">[</span><span class="s1">&#39;elec_cost_without_system_year1&#39;</span><span class="p">]</span>

        <span class="n">npv</span> <span class="o">=</span> <span class="n">npv_w_batt</span>
        <span class="n">payback</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;payback&#39;</span><span class="p">]</span>
        <span class="n">cash_flow</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_payback_with_expenses&#39;</span><span class="p">])</span> <span class="c1"># ?</span>

        <span class="n">cbi_total</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cbi_total&#39;</span><span class="p">]</span>
        <span class="n">cbi_total_fed</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cbi_total_fed&#39;</span><span class="p">]</span>
        <span class="n">cbi_total_oth</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cbi_total_oth&#39;</span><span class="p">]</span>
        <span class="n">cbi_total_sta</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cbi_total_sta&#39;</span><span class="p">]</span>
        <span class="n">cbi_total_uti</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cbi_total_uti&#39;</span><span class="p">]</span>

        <span class="n">ibi_total</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;ibi_total&#39;</span><span class="p">]</span>
        <span class="n">ibi_total_fed</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;ibi_total_fed&#39;</span><span class="p">]</span>
        <span class="n">ibi_total_oth</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;ibi_total_oth&#39;</span><span class="p">]</span>
        <span class="n">ibi_total_sta</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;ibi_total_sta&#39;</span><span class="p">]</span>
        <span class="n">ibi_total_uti</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;ibi_total_uti&#39;</span><span class="p">]</span>

        <span class="n">cf_pbi_total</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_pbi_total&#39;</span><span class="p">]</span>
        <span class="n">pbi_total_fed</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_pbi_total_fed&#39;</span><span class="p">]</span>
        <span class="n">pbi_total_oth</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_pbi_total_oth&#39;</span><span class="p">]</span>
        <span class="n">pbi_total_sta</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_pbi_total_sta&#39;</span><span class="p">]</span>
        <span class="n">pbi_total_uti</span> <span class="o">=</span> <span class="n">batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_pbi_total_uti&#39;</span><span class="p">]</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="n">system_kw</span> <span class="o">=</span> <span class="n">res_no_batt</span><span class="o">.</span><span class="n">x</span>
        <span class="n">annual_energy_production_kwh</span> <span class="o">=</span> <span class="n">no_batt_annual_energy_kwh</span>
        <span class="n">first_year_elec_bill_with_system</span> <span class="o">=</span> <span class="n">no_batt_util_outputs</span><span class="p">[</span><span class="s1">&#39;elec_cost_with_system_year1&#39;</span><span class="p">]</span>
        <span class="n">first_year_elec_bill_without_system</span> <span class="o">=</span> <span class="n">no_batt_util_outputs</span><span class="p">[</span><span class="s1">&#39;elec_cost_without_system_year1&#39;</span><span class="p">]</span>

        <span class="n">npv</span> <span class="o">=</span> <span class="n">npv_no_batt</span>
        <span class="n">payback</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;payback&#39;</span><span class="p">]</span>
        <span class="n">cash_flow</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_payback_with_expenses&#39;</span><span class="p">])</span>

        <span class="n">batt_kw</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batt_kwh</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batt_dispatch_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">cbi_total</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cbi_total&#39;</span><span class="p">]</span>
        <span class="n">cbi_total_fed</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cbi_total_fed&#39;</span><span class="p">]</span>
        <span class="n">cbi_total_oth</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cbi_total_oth&#39;</span><span class="p">]</span>
        <span class="n">cbi_total_sta</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cbi_total_sta&#39;</span><span class="p">]</span>
        <span class="n">cbi_total_uti</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cbi_total_uti&#39;</span><span class="p">]</span>

        <span class="n">ibi_total</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;ibi_total&#39;</span><span class="p">]</span>
        <span class="n">ibi_total_fed</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;ibi_total_fed&#39;</span><span class="p">]</span>
        <span class="n">ibi_total_oth</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;ibi_total_oth&#39;</span><span class="p">]</span>
        <span class="n">ibi_total_sta</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;ibi_total_sta&#39;</span><span class="p">]</span>
        <span class="n">ibi_total_uti</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;ibi_total_uti&#39;</span><span class="p">]</span>

        <span class="n">cf_pbi_total</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_pbi_total&#39;</span><span class="p">]</span>
        <span class="n">pbi_total_fed</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_pbi_total_fed&#39;</span><span class="p">]</span>
        <span class="n">pbi_total_oth</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_pbi_total_oth&#39;</span><span class="p">]</span>
        <span class="n">pbi_total_sta</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_pbi_total_sta&#39;</span><span class="p">]</span>
        <span class="n">pbi_total_uti</span> <span class="o">=</span> <span class="n">no_batt_loan_outputs</span><span class="p">[</span><span class="s1">&#39;cf_pbi_total_uti&#39;</span><span class="p">]</span>
        

    <span class="c1"># change 0 value to 1 to avoid divide by zero errors</span>
    <span class="k">if</span> <span class="n">first_year_elec_bill_without_system</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">first_year_elec_bill_without_system</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># Add outputs to agent df    </span>
    <span class="n">naep</span> <span class="o">=</span> <span class="n">annual_energy_production_kwh</span> <span class="o">/</span> <span class="n">system_kw</span>
    <span class="n">first_year_elec_bill_savings</span> <span class="o">=</span> <span class="n">first_year_elec_bill_without_system</span> <span class="o">-</span> <span class="n">first_year_elec_bill_with_system</span>
    <span class="n">first_year_elec_bill_savings_frac</span> <span class="o">=</span> <span class="n">first_year_elec_bill_savings</span> <span class="o">/</span> <span class="n">first_year_elec_bill_without_system</span>
    <span class="n">avg_elec_price_cents_per_kwh</span> <span class="o">=</span> <span class="n">first_year_elec_bill_without_system</span> <span class="o">/</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;load_kwh_per_customer_in_bin&#39;</span><span class="p">]</span>

    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;system_kw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">system_kw</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npv</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;payback_period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">payback</span><span class="p">),</span> <span class="mf">30.1</span><span class="p">,</span> <span class="n">payback</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;cash_flow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash_flow</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;annual_energy_production_kwh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annual_energy_production_kwh</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;naep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">naep</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;capacity_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;naep&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">8760</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;first_year_elec_bill_with_system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_year_elec_bill_with_system</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;first_year_elec_bill_savings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_year_elec_bill_savings</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;first_year_elec_bill_savings_frac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_year_elec_bill_savings_frac</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;max_system_kw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_system_kw</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;first_year_elec_bill_without_system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_year_elec_bill_without_system</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;avg_elec_price_cents_per_kwh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_elec_price_cents_per_kwh</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_kw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batt_kw</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_kwh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batt_kwh</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;batt_dispatch_profile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batt_dispatch_profile</span>

    <span class="c1"># Financial outputs (find out which ones to include): </span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;cbi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">({</span><span class="s1">&#39;cbi_total&#39;</span><span class="p">:</span> <span class="n">cbi_total</span><span class="p">,</span>
            <span class="s1">&#39;cbi_total_fed&#39;</span><span class="p">:</span> <span class="n">cbi_total_fed</span><span class="p">,</span>
            <span class="s1">&#39;cbi_total_oth&#39;</span><span class="p">:</span> <span class="n">cbi_total_oth</span><span class="p">,</span>
            <span class="s1">&#39;cbi_total_sta&#39;</span><span class="p">:</span> <span class="n">cbi_total_sta</span><span class="p">,</span>
            <span class="s1">&#39;cbi_total_uti&#39;</span><span class="p">:</span> <span class="n">cbi_total_uti</span>
           <span class="p">})</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;ibi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">({</span><span class="s1">&#39;ibi_total&#39;</span><span class="p">:</span> <span class="n">ibi_total</span><span class="p">,</span>
            <span class="s1">&#39;ibi_total_fed&#39;</span><span class="p">:</span> <span class="n">ibi_total_fed</span><span class="p">,</span>
            <span class="s1">&#39;ibi_total_oth&#39;</span><span class="p">:</span> <span class="n">ibi_total_oth</span><span class="p">,</span>
            <span class="s1">&#39;ibi_total_sta&#39;</span><span class="p">:</span> <span class="n">ibi_total_sta</span><span class="p">,</span>
            <span class="s1">&#39;ibi_total_uti&#39;</span><span class="p">:</span> <span class="n">ibi_total_uti</span>
           <span class="p">})</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;pbi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">({</span><span class="s1">&#39;pbi_total&#39;</span><span class="p">:</span> <span class="n">cf_pbi_total</span><span class="p">,</span>
            <span class="s1">&#39;pbi_total_fed&#39;</span><span class="p">:</span> <span class="n">pbi_total_fed</span><span class="p">,</span>
            <span class="s1">&#39;pbi_total_oth&#39;</span><span class="p">:</span> <span class="n">pbi_total_oth</span><span class="p">,</span>
            <span class="s1">&#39;pbi_total_sta&#39;</span><span class="p">:</span> <span class="n">pbi_total_sta</span><span class="p">,</span>
            <span class="s1">&#39;pbi_total_uti&#39;</span><span class="p">:</span> <span class="n">pbi_total_uti</span>
            <span class="p">})</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;cash_incentives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;export_tariff_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> 

    <span class="n">out_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;agent_id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;system_kw&#39;</span><span class="p">,</span>
                <span class="s1">&#39;batt_kw&#39;</span><span class="p">,</span>
                <span class="s1">&#39;batt_kwh&#39;</span><span class="p">,</span>
                <span class="s1">&#39;npv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;payback_period&#39;</span><span class="p">,</span>
                <span class="s1">&#39;cash_flow&#39;</span><span class="p">,</span>
                <span class="s1">&#39;batt_dispatch_profile&#39;</span><span class="p">,</span>
                <span class="s1">&#39;annual_energy_production_kwh&#39;</span><span class="p">,</span>
                <span class="s1">&#39;naep&#39;</span><span class="p">,</span>
                <span class="s1">&#39;capacity_factor&#39;</span><span class="p">,</span>
                <span class="s1">&#39;first_year_elec_bill_with_system&#39;</span><span class="p">,</span>
                <span class="s1">&#39;first_year_elec_bill_savings&#39;</span><span class="p">,</span>
                <span class="s1">&#39;first_year_elec_bill_savings_frac&#39;</span><span class="p">,</span>
                <span class="s1">&#39;max_system_kw&#39;</span><span class="p">,</span>
                <span class="s1">&#39;first_year_elec_bill_without_system&#39;</span><span class="p">,</span>
                <span class="s1">&#39;avg_elec_price_cents_per_kwh&#39;</span><span class="p">,</span>
                <span class="s1">&#39;cbi&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ibi&#39;</span><span class="p">,</span>
                <span class="s1">&#39;pbi&#39;</span><span class="p">,</span>
                <span class="s1">&#39;cash_incentives&#39;</span><span class="p">,</span>
                <span class="s1">&#39;export_tariff_results&#39;</span>
                <span class="p">]</span>

    <span class="k">return</span> <span class="n">agent</span><span class="p">[</span><span class="n">out_cols</span><span class="p">]</span></div>

<span class="c1">#%%</span>
<div class="viewcode-block" id="process_tariff"><a class="viewcode-back" href="../../api.html#python.financial_functions.process_tariff">[docs]</a><span class="k">def</span> <span class="nf">process_tariff</span><span class="p">(</span><span class="n">utilityrate</span><span class="p">,</span> <span class="n">tariff_dict</span><span class="p">,</span> <span class="n">net_billing_sell_rate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiate the utilityrate5 PySAM model and process the agent&#39;s rate json object to conform with PySAM input formatting.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    agent : &#39;pd.Series&#39;</span>
<span class="sd">        Individual agent object.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    utilityrate: &#39;PySAM.Utilityrate5&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    
    <span class="c1">######################################</span>
    <span class="c1">###--------- UTILITYRATE5 ---------###</span>
    <span class="c1">###--- FIXED AND ANNUAL CHARGES ---###</span>
    <span class="c1">######################################</span>
    
    <span class="c1"># Monthly fixed charge [$]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_monthly_fixed_charge</span> <span class="o">=</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;fixed_charge&#39;</span><span class="p">]</span>
    <span class="c1"># Annual minimum charge [$]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_annual_min_charge</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># not currently tracked in URDB rate attribute downloads</span>
    <span class="c1"># Monthly minimum charge [$]</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_monthly_min_charge</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># not currently tracked in URDB rate attribute downloads</span>
    
    
    <span class="c1">######################################</span>
    <span class="c1">###--------- UTILITYRATE5 ---------###</span>
    <span class="c1">###-------- DEMAND CHARGES --------###</span>
    <span class="c1">######################################</span>
    
    <span class="c1"># Enable demand charge</span>
    <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_dc_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_flat_exists&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_tou_exists&#39;</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_dc_enable</span><span class="p">:</span>
    
        <span class="k">if</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_flat_exists&#39;</span><span class="p">]:</span>
            
            <span class="c1"># Reformat demand charge table from dGen format</span>
            <span class="n">n_periods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_flat_levels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">n_tiers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_flat_levels&#39;</span><span class="p">])</span>
            <span class="n">ur_dc_flat_mat</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_periods</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiers</span><span class="p">):</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">period</span><span class="p">,</span> <span class="n">tier</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_flat_levels&#39;</span><span class="p">][</span><span class="n">tier</span><span class="p">][</span><span class="n">period</span><span class="p">],</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_flat_prices&#39;</span><span class="p">][</span><span class="n">tier</span><span class="p">][</span><span class="n">period</span><span class="p">]]</span>
                    <span class="n">ur_dc_flat_mat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            
            <span class="c1"># Demand rates (flat) table</span>
            <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_dc_flat_mat</span> <span class="o">=</span> <span class="n">ur_dc_flat_mat</span>
        
        
        <span class="k">if</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_tou_exists&#39;</span><span class="p">]:</span>
            
            <span class="c1"># Reformat demand charge table from dGen format</span>
            <span class="n">n_periods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_tou_levels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">n_tiers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_tou_levels&#39;</span><span class="p">])</span>
            <span class="n">ur_dc_tou_mat</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_periods</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiers</span><span class="p">):</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">period</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">tier</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_tou_levels&#39;</span><span class="p">][</span><span class="n">tier</span><span class="p">][</span><span class="n">period</span><span class="p">],</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_tou_prices&#39;</span><span class="p">][</span><span class="n">tier</span><span class="p">][</span><span class="n">period</span><span class="p">]]</span>
                    <span class="n">ur_dc_tou_mat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            
            <span class="c1"># Demand rates (TOU) table</span>
            <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_dc_tou_mat</span> <span class="o">=</span> <span class="n">ur_dc_tou_mat</span>
    
    
        <span class="c1"># Reformat 12x24 tables - original are indexed to 0, PySAM needs index starting at 1</span>
        <span class="n">d_wkday_12by24</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_wkday_12by24&#39;</span><span class="p">])):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_wkday_12by24&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]]</span>
            <span class="n">d_wkday_12by24</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            
        <span class="n">d_wkend_12by24</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_wkend_12by24&#39;</span><span class="p">])):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;d_wkend_12by24&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]]</span>
            <span class="n">d_wkend_12by24</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="c1"># Demand charge weekday schedule</span>
        <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_dc_sched_weekday</span> <span class="o">=</span> <span class="n">d_wkday_12by24</span>
        <span class="c1"># Demand charge weekend schedule</span>
        <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_dc_sched_weekend</span> <span class="o">=</span> <span class="n">d_wkend_12by24</span>
    
    
    <span class="c1">######################################</span>
    <span class="c1">###--------- UTILITYRATE5 ---------###</span>
    <span class="c1">###-------- ENERGY CHARGES --------###</span>
    <span class="c1">######################################</span>
    
    <span class="k">if</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;e_exists&#39;</span><span class="p">]:</span>
        
        <span class="c1"># Dictionary to map dGen max usage units to PySAM options</span>
        <span class="n">max_usage_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;kWh&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;kWh/kW&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kWh daily&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;kWh/kW daily&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
        <span class="c1"># If max usage units are &#39;kWh daily&#39;, divide max usage by 30 -- rate download procedure converts daily to monthly</span>
        <span class="n">modifier</span> <span class="o">=</span> <span class="mf">30.</span> <span class="k">if</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;energy_rate_unit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;kWh daily&#39;</span> <span class="k">else</span> <span class="mf">1.</span>
        
        <span class="c1"># Reformat energy charge table from dGen format</span>
        <span class="n">n_periods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;e_levels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">n_tiers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;e_levels&#39;</span><span class="p">])</span>
        <span class="n">ur_ec_tou_mat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_periods</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiers</span><span class="p">):</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">period</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">tier</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;e_levels&#39;</span><span class="p">][</span><span class="n">tier</span><span class="p">][</span><span class="n">period</span><span class="p">],</span> <span class="n">max_usage_dict</span><span class="p">[</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;energy_rate_unit&#39;</span><span class="p">]],</span>
                 <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;e_prices&#39;</span><span class="p">][</span><span class="n">tier</span><span class="p">][</span><span class="n">period</span><span class="p">],</span> <span class="n">net_billing_sell_rate</span><span class="p">]</span>
                <span class="n">ur_ec_tou_mat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        
        <span class="c1"># Energy rates table</span>
        <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_ec_tou_mat</span> <span class="o">=</span> <span class="n">ur_ec_tou_mat</span>
        
        <span class="c1"># Reformat 12x24 tables - original are indexed to 0, PySAM needs index starting at 1</span>
        <span class="n">e_wkday_12by24</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;e_wkday_12by24&#39;</span><span class="p">])):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;e_wkday_12by24&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]]</span>
            <span class="n">e_wkday_12by24</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            
        <span class="n">e_wkend_12by24</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;e_wkend_12by24&#39;</span><span class="p">])):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tariff_dict</span><span class="p">[</span><span class="s1">&#39;e_wkend_12by24&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]]</span>
            <span class="n">e_wkend_12by24</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        
        <span class="c1"># Energy charge weekday schedule</span>
        <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_ec_sched_weekday</span> <span class="o">=</span> <span class="n">e_wkday_12by24</span>
        <span class="c1"># Energy charge weekend schedule</span>
        <span class="n">utilityrate</span><span class="o">.</span><span class="n">ElectricityRates</span><span class="o">.</span><span class="n">ur_ec_sched_weekend</span> <span class="o">=</span> <span class="n">e_wkend_12by24</span>
        
    
    <span class="k">return</span> <span class="n">utilityrate</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="process_incentives"><a class="viewcode-back" href="../../api.html#python.financial_functions.process_incentives">[docs]</a><span class="k">def</span> <span class="nf">process_incentives</span><span class="p">(</span><span class="n">loan</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">batt_kw</span><span class="p">,</span> <span class="n">batt_kwh</span><span class="p">,</span> <span class="n">generation_hourly</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
    
    <span class="c1">######################################</span>
    <span class="c1">###----------- CASHLOAN -----------###</span>
    <span class="c1">###------ PAYMENT INCENTIVES ------###</span>
    <span class="c1">######################################</span>

    <span class="c1"># Read incentive dataframe from agent attributes</span>
    <span class="n">incentive_df</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;state_incentives&#39;</span><span class="p">]</span>
    
    <span class="c1"># Check dtype of incentive_df - process incentives if pd.DataFrame, otherwise do not assign incentive values to cashloan</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incentive_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        
        <span class="c1"># Fill NaNs in incentive_df - assume max incentive duration of 5 years and max incentive value of $10,000</span>
        <span class="n">incentive_df</span> <span class="o">=</span> <span class="n">incentive_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;incentive_duration_yrs&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;max_incentive_usd&#39;</span> <span class="p">:</span> <span class="mi">10000</span><span class="p">})</span>
        <span class="c1"># Filter for CBI&#39;s in incentive_df</span>
        <span class="n">cbi_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">incentive_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">incentive_df</span><span class="p">[</span><span class="s1">&#39;cbi_usd_p_w&#39;</span><span class="p">])]</span>                  
                  <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;cbi_usd_p_w&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                  <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="p">)</span>
        
        <span class="c1"># Process state capacity-based incentives (CBI)</span>
        <span class="c1">#cbi_value = calculate_capacity_based_incentives(kw, batt_kw, batt_kwh, agent)</span>
        
        <span class="c1"># For multiple CBIs that are applicable to the agent, cap at 2 and use PySAM&#39;s &quot;state&quot; and &quot;other&quot; option</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbi_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_amount</span> <span class="o">=</span> <span class="n">cbi_df</span><span class="p">[</span><span class="s1">&#39;cbi_usd_p_w&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_deprbas_fed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_deprbas_sta</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_maxvalue</span> <span class="o">=</span> <span class="n">cbi_df</span><span class="p">[</span><span class="s1">&#39;max_incentive_usd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_tax_fed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_tax_sta</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbi_df</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_amount</span> <span class="o">=</span> <span class="n">cbi_df</span><span class="p">[</span><span class="s1">&#39;cbi_usd_p_w&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_deprbas_fed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_deprbas_sta</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_maxvalue</span> <span class="o">=</span> <span class="n">cbi_df</span><span class="p">[</span><span class="s1">&#39;max_incentive_usd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_tax_fed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_sta_tax_sta</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_oth_amount</span> <span class="o">=</span> <span class="n">cbi_df</span><span class="p">[</span><span class="s1">&#39;cbi_usd_p_w&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_oth_deprbas_fed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_oth_deprbas_sta</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_oth_maxvalue</span> <span class="o">=</span> <span class="n">cbi_df</span><span class="p">[</span><span class="s1">&#39;max_incentive_usd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_oth_tax_fed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">cbi_oth_tax_sta</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="c1"># Filter for PBI&#39;s in incentive_df</span>
        <span class="n">pbi_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">incentive_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">incentive_df</span><span class="p">[</span><span class="s1">&#39;pbi_usd_p_kwh&#39;</span><span class="p">])]</span>
                  <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;pbi_usd_p_kwh&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                  <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="p">)</span>
        
        <span class="c1"># Process state production-based incentives (CBI)</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;timesteps_per_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pv_kwh_by_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">generation_hourly</span><span class="p">),</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;timesteps_per_year&#39;</span><span class="p">]))))</span>
        <span class="n">pv_kwh_by_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([(</span><span class="n">pv_kwh_by_year</span> <span class="o">-</span> <span class="p">(</span><span class="n">pv_kwh_by_year</span> <span class="o">*</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;pv_degradation_factor&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;economic_lifetime_yrs&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">kwh_by_timestep</span> <span class="o">=</span> <span class="n">kw</span> <span class="o">*</span> <span class="n">pv_kwh_by_year</span>
        
        <span class="c1">#pbi_value = calculate_production_based_incentives(kw, kwh_by_timestep, agent)</span>
    
        <span class="c1"># For multiple PBIs that are applicable to the agent, cap at 2 and use PySAM&#39;s &quot;state&quot; and &quot;other&quot; option</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pbi_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            
            <span class="c1"># Aamount input [$/kWh] requires sequence -- repeat pbi_usd_p_kwh using incentive_duration_yrs </span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_sta_amount</span> <span class="o">=</span> <span class="p">[</span><span class="n">pbi_df</span><span class="p">[</span><span class="s1">&#39;pbi_usd_p_kwh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">pbi_df</span><span class="p">[</span><span class="s1">&#39;incentive_duration_yrs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_sta_escal</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_sta_tax_fed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_sta_tax_sta</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_sta_term</span> <span class="o">=</span> <span class="n">pbi_df</span><span class="p">[</span><span class="s1">&#39;incentive_duration_yrs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pbi_df</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            
            <span class="c1"># Aamount input [$/kWh] requires sequence -- repeat pbi_usd_p_kwh using incentive_duration_yrs </span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_sta_amount</span> <span class="o">=</span> <span class="p">[</span><span class="n">pbi_df</span><span class="p">[</span><span class="s1">&#39;pbi_usd_p_kwh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">pbi_df</span><span class="p">[</span><span class="s1">&#39;incentive_duration_yrs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_sta_escal</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_sta_tax_fed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_sta_tax_sta</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_sta_term</span> <span class="o">=</span> <span class="n">pbi_df</span><span class="p">[</span><span class="s1">&#39;incentive_duration_yrs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># Aamount input [$/kWh] requires sequence -- repeat pbi_usd_p_kwh using incentive_duration_yrs </span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_oth_amount</span> <span class="o">=</span> <span class="p">[</span><span class="n">pbi_df</span><span class="p">[</span><span class="s1">&#39;pbi_usd_p_kwh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">pbi_df</span><span class="p">[</span><span class="s1">&#39;incentive_duration_yrs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_oth_escal</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_oth_tax_fed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_oth_tax_sta</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">pbi_oth_term</span> <span class="o">=</span> <span class="n">pbi_df</span><span class="p">[</span><span class="s1">&#39;incentive_duration_yrs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="c1"># Filter for IBI&#39;s in incentive_df</span>
        <span class="n">ibi_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">incentive_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">incentive_df</span><span class="p">[</span><span class="s1">&#39;ibi_pct&#39;</span><span class="p">])]</span>
                  <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;ibi_pct&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                  <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="p">)</span>
        
        <span class="c1"># Process state investment-based incentives (CBI)</span>
        <span class="c1">#ibi_value = calculate_investment_based_incentives(kw, batt_kw, batt_kwh, agent)</span>
        
        <span class="c1"># For multiple IBIs that are applicable to the agent, cap at 2 and use PySAM&#39;s &quot;state&quot; and &quot;other&quot; option</span>
        <span class="c1"># NOTE: this specifies IBI percentage, instead of IBI absolute amount</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibi_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent</span> <span class="o">=</span> <span class="n">ibi_df</span><span class="p">[</span><span class="s1">&#39;ibi_pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent_deprbas_fed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent_deprbas_sta</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent_maxvalue</span> <span class="o">=</span> <span class="n">ibi_df</span><span class="p">[</span><span class="s1">&#39;max_incentive_usd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent_tax_fed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent_tax_sta</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibi_df</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent</span> <span class="o">=</span> <span class="n">ibi_df</span><span class="p">[</span><span class="s1">&#39;ibi_pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent_deprbas_fed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent_deprbas_sta</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent_maxvalue</span> <span class="o">=</span> <span class="n">ibi_df</span><span class="p">[</span><span class="s1">&#39;max_incentive_usd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent_tax_fed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_sta_percent_tax_sta</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_oth_percent</span> <span class="o">=</span> <span class="n">ibi_df</span><span class="p">[</span><span class="s1">&#39;ibi_pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_oth_percent_deprbas_fed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_oth_percent_deprbas_sta</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_oth_percent_maxvalue</span> <span class="o">=</span> <span class="n">ibi_df</span><span class="p">[</span><span class="s1">&#39;max_incentive_usd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_oth_percent_tax_fed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">loan</span><span class="o">.</span><span class="n">PaymentIncentives</span><span class="o">.</span><span class="n">ibi_oth_percent_tax_sta</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">return</span> <span class="n">loan</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="calc_financial_performance"><a class="viewcode-back" href="../../api.html#python.financial_functions.calc_financial_performance">[docs]</a><span class="nd">@decorators</span><span class="o">.</span><span class="n">fn_timer</span><span class="p">(</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">,</span> <span class="n">tab_level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">calc_financial_performance</span><span class="p">(</span><span class="n">dataframe</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the payback period and join it on the agent dataframe</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataframe : &quot;pd.df&quot;</span>
<span class="sd">        Agent dataframe</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    - dataframe: &#39;pd.df&#39; - Agent dataframe with payback period joined on dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">cfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;cash_flow&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>    
    
    <span class="c1"># calculate payback period</span>
    <span class="n">tech_lifetime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cfs</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">payback</span> <span class="o">=</span> <span class="n">calc_payback_vectorized</span><span class="p">(</span><span class="n">cfs</span><span class="p">,</span> <span class="n">tech_lifetime</span><span class="p">)</span>

    <span class="c1"># All agents (residential and non-residential use payback period)</span>
    <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;payback_period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">payback</span>
    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;agent_id&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataframe</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="calc_payback_vectorized"><a class="viewcode-back" href="../../api.html#python.financial_functions.calc_payback_vectorized">[docs]</a><span class="k">def</span> <span class="nf">calc_payback_vectorized</span><span class="p">(</span><span class="n">cfs</span><span class="p">,</span> <span class="n">tech_lifetime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the payback period in years for a given cash flow. Payback is defined as the first year where cumulative cash flows are positive.</span>
<span class="sd">    Cash flows that do not result in payback are given a period of 30.1</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cfs : &quot;numpy.ndarray&quot;</span>
<span class="sd">        Annual cash flows of investment, where 0th index refers to 0th year of investment</span>
<span class="sd">    tech_lifetime : &quot;numpy.ndarray&quot;</span>
<span class="sd">        Number of years to assume for technology lifetime</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pp_final : &#39;numpy.ndarray&#39;</span>
<span class="sd">        Payback period in years</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tech_lifetime</span><span class="p">)]</span> <span class="o">*</span> <span class="n">cfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">cum_cfs</span> <span class="o">=</span> <span class="n">cfs</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>   
    <span class="n">no_payback</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cum_cfs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cum_cfs</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">instant_payback</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cum_cfs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">neg_to_pos_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cum_cfs</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">base_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">neg_to_pos_years</span><span class="p">,</span> <span class="n">years</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># replace values of -1 with 30</span>
    <span class="n">base_years_fix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">base_years</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">tech_lifetime</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">base_years</span><span class="p">)</span>
    <span class="n">base_year_mask</span> <span class="o">=</span> <span class="n">years</span> <span class="o">==</span> <span class="n">base_years_fix</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="c1"># base year values</span>
    <span class="n">base_year_values</span> <span class="o">=</span> <span class="n">cum_cfs</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">base_year_mask</span><span class="p">]</span>
    <span class="n">next_year_values</span> <span class="o">=</span> <span class="n">cum_cfs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:][</span><span class="n">base_year_mask</span><span class="p">]</span>
    <span class="n">frac_years</span> <span class="o">=</span> <span class="n">base_year_values</span><span class="o">/</span><span class="p">(</span><span class="n">base_year_values</span> <span class="o">-</span> <span class="n">next_year_values</span><span class="p">)</span>
    <span class="n">pp_year</span> <span class="o">=</span> <span class="n">base_years_fix</span> <span class="o">+</span> <span class="n">frac_years</span>
    <span class="n">pp_precise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">no_payback</span><span class="p">,</span> <span class="mf">30.1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">instant_payback</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pp_year</span><span class="p">))</span>
    
    <span class="c1"># round to nearest 0.1 to join with max_market_share</span>
    <span class="n">pp_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pp_precise</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">pp_final</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="calc_max_market_share"><a class="viewcode-back" href="../../api.html#python.financial_functions.calc_max_market_share">[docs]</a><span class="nd">@decorators</span><span class="o">.</span><span class="n">fn_timer</span><span class="p">(</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">,</span> <span class="n">tab_level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">calc_max_market_share</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">max_market_share_df</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the maximum marketshare available for each agent. </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataframe : pandas.DataFrame</span>
<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        metric_value : float</span>
<span class="sd">            </span>
<span class="sd">    max_market_share_df : pandas.DataFrame</span>
<span class="sd">        Set by :meth:`settings.ScenarioSettings.get_max_marketshare`.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Input DataFrame with `max_market_share` and `metric` columns joined on.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">in_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;business_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;host_owned&#39;</span>
    <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;payback_period&#39;</span>
    
    <span class="c1"># Convert metric value to integer as a primary key, then bound within max market share ranges</span>
    <span class="n">max_payback</span> <span class="o">=</span> <span class="n">max_market_share_df</span><span class="p">[</span><span class="n">max_market_share_df</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;payback_period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">payback_period</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">min_payback</span> <span class="o">=</span> <span class="n">max_market_share_df</span><span class="p">[</span><span class="n">max_market_share_df</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;payback_period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">payback_period</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">max_mbs</span> <span class="o">=</span> <span class="n">max_market_share_df</span><span class="p">[</span><span class="n">max_market_share_df</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;percent_monthly_bill_savings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">payback_period</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">min_mbs</span> <span class="o">=</span> <span class="n">max_market_share_df</span><span class="p">[</span><span class="n">max_market_share_df</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;percent_monthly_bill_savings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">payback_period</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    
    <span class="c1"># copy the metric valeus to a new column to store an edited version</span>
    <span class="n">payback_period_bounded</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;payback_period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># where the metric value exceeds the corresponding max market curve bounds, set the value to the corresponding bound</span>
    <span class="n">payback_period_bounded</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dataframe</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;payback_period&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;payback_period&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_payback</span><span class="p">))]</span> <span class="o">=</span> <span class="n">min_payback</span>
    <span class="n">payback_period_bounded</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dataframe</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;payback_period&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;payback_period&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_payback</span><span class="p">))]</span> <span class="o">=</span> <span class="n">max_payback</span>    
    <span class="n">payback_period_bounded</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dataframe</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;percent_monthly_bill_savings&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;payback_period&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_mbs</span><span class="p">))]</span> <span class="o">=</span> <span class="n">min_mbs</span>
    <span class="n">payback_period_bounded</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dataframe</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;percent_monthly_bill_savings&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;payback_period&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_mbs</span><span class="p">))]</span> <span class="o">=</span> <span class="n">max_mbs</span>
    <span class="c1">#dataframe[&#39;payback_period_bounded&#39;] = payback_period_bounded</span>
    <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;payback_period_bounded&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">payback_period_bounded</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># scale and round to nearest int    </span>
    <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;payback_period_as_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;payback_period_bounded&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="c1"># add a scaled key to the max_market_share dataframe too</span>
    <span class="n">max_market_share_df</span><span class="p">[</span><span class="s1">&#39;payback_period_as_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_market_share_df</span><span class="p">[</span><span class="s1">&#39;payback_period&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

    <span class="c1"># Join the max_market_share table and dataframe in order to select the ultimate mms based on the metric value. </span>
    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">max_market_share_df</span><span class="p">[[</span><span class="s1">&#39;sector_abbr&#39;</span><span class="p">,</span> <span class="s1">&#39;max_market_share&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;payback_period_as_factor&#39;</span><span class="p">,</span> <span class="s1">&#39;business_model&#39;</span><span class="p">]],</span> 
        <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sector_abbr&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span><span class="s1">&#39;payback_period_as_factor&#39;</span><span class="p">,</span><span class="s1">&#39;business_model&#39;</span><span class="p">])</span>
    
    <span class="n">out_cols</span> <span class="o">=</span> <span class="n">in_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;max_market_share&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">]</span>    

    <span class="k">return</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">out_cols</span><span class="p">]</span></div>


<span class="c1">#%%</span>
<span class="c1"># system_costs --&gt; ssytem_cost look for error in later commits?</span>
<div class="viewcode-block" id="check_incentive_constraints"><a class="viewcode-back" href="../../api.html#python.financial_functions.check_incentive_constraints">[docs]</a><span class="k">def</span> <span class="nf">check_incentive_constraints</span><span class="p">(</span><span class="n">incentive_data</span><span class="p">,</span> <span class="n">incentive_value</span><span class="p">,</span> <span class="n">system_cost</span><span class="p">):</span>
    <span class="c1"># Reduce the incentive if is is more than the max allowable payment (by percent total costs)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">incentive_data</span><span class="p">[</span><span class="s1">&#39;max_incentive_usd&#39;</span><span class="p">]):</span>
        <span class="n">incentive_value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">incentive_value</span><span class="p">,</span> <span class="n">incentive_data</span><span class="p">[</span><span class="s1">&#39;max_incentive_usd&#39;</span><span class="p">])</span>

    <span class="c1"># Reduce the incentive if is is more than the max allowable payment (by percent of total installed costs)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">incentive_data</span><span class="p">[</span><span class="s1">&#39;max_incentive_pct&#39;</span><span class="p">]):</span>
        <span class="n">incentive_value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">incentive_value</span><span class="p">,</span> <span class="n">system_cost</span> <span class="o">*</span> <span class="n">incentive_data</span><span class="p">[</span><span class="s1">&#39;max_incentive_pct&#39;</span><span class="p">])</span>

    <span class="c1"># Set the incentive to zero if it is less than the minimum incentive</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">incentive_data</span><span class="p">[</span><span class="s1">&#39;min_incentive_usd&#39;</span><span class="p">]):</span>
        <span class="n">incentive_value</span> <span class="o">*=</span> <span class="nb">int</span><span class="p">(</span><span class="n">incentive_value</span> <span class="o">&gt;</span> <span class="n">incentive_data</span><span class="p">[</span><span class="s1">&#39;min_incentive_usd&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">incentive_value</span></div>


<span class="c1"># #%%</span>
<span class="c1"># def calculate_investment_based_incentives(pv, batt_kw, batt_kwh, agent):</span>
<span class="c1">#     # Get State Incentives that have a valid Investment Based Incentive value (based on percent of total installed costs)</span>
<span class="c1">#     ibi_list = agent.loc[&#39;state_incentives&#39;].loc[pd.notnull(agent.loc[&#39;state_incentives&#39;][&#39;ibi_pct&#39;])]</span>

<span class="c1">#     # Create a empty dataframe to store cumulative ibi&#39;s for each system configuration</span>
<span class="c1">#     result = 0.</span>

<span class="c1">#     # Loop through each incenctive and add it to the result df</span>
<span class="c1">#     for row in ibi_list.to_dict(&#39;records&#39;):</span>
<span class="c1">#         if row[&#39;tech&#39;] == &#39;solar&#39;:</span>
<span class="c1">#             # Size filer calls a function to check for valid system size limitations - a boolean so if the size in invalid it will add zero&#39;s to the results df</span>
<span class="c1">#             size_filter = check_minmax(pv, row[&#39;min_kw&#39;], row[&#39;max_kw&#39;])</span>

<span class="c1">#             # Scale costs based on system size</span>
<span class="c1">#             system_cost = (pv * agent.loc[&#39;system_capex_per_kw&#39;])</span>

<span class="c1">#         if row[&#39;tech&#39;] == &#39;storage&#39;:</span>
<span class="c1">#             # Size filer calls a function to check for valid system size limitations - a boolean so if the size in invalid it will add zero&#39;s to the results df</span>
<span class="c1">#             size_filter = check_minmax(batt_kwh, row[&#39;min_kwh&#39;], row[&#39;max_kwh&#39;])</span>
<span class="c1">#             size_filter = size_filter * check_minmax(batt_kw, row[&#39;min_kw&#39;], row[&#39;max_kw&#39;])</span>

<span class="c1">#             # Calculate system costs</span>
<span class="c1">#             system_costs = (batt_kw * agent.loc[&#39;batt_capex_per_kw&#39;]) + (batt_kwh * agent.loc[&#39;batt_capex_per_kwh&#39;])</span>

<span class="c1">#         # Total incentive</span>
<span class="c1">#         incentive_value = (system_cost * row[&#39;ibi_pct&#39;]) * size_filter</span>

<span class="c1">#         # Add the result to the cumulative total</span>
<span class="c1">#         result += check_incentive_constraints(row, incentive_value, system_cost)</span>

<span class="c1">#     return np.array(result)</span>


<span class="c1">#%%</span>
<span class="c1"># def calculate_capacity_based_incentives(pv, batt_kw, batt_kwh, agent):</span>

<span class="c1">#     # Get State Incentives that have a valid Capacity Based Incentive value (based on $ per watt)</span>
<span class="c1">#     cbi_list = agent.loc[&#39;state_incentives&#39;].loc[pd.notnull(agent.loc[&#39;state_incentives&#39;][&#39;cbi_usd_p_w&#39;]) | pd.notnull(agent.loc[&#39;state_incentives&#39;][&#39;cbi_usd_p_wh&#39;])]</span>

<span class="c1">#     # Create a empty dataframe to store cumulative bi&#39;s for each system configuration</span>
<span class="c1">#     result = 0.</span>

<span class="c1">#     # Loop through each incenctive and add it to the result df</span>
<span class="c1">#     for row in cbi_list.to_dict(&#39;records&#39;):</span>

<span class="c1">#         if row[&#39;tech&#39;] == &#39;solar&#39;:</span>
<span class="c1">#             # Size filer calls a function to check for valid system size limitations - a boolean so if the size in invalid it will add zero&#39;s to the results df</span>
<span class="c1">#             size_filter = check_minmax(pv, row[&#39;min_kw&#39;], row[&#39;max_kw&#39;])</span>

<span class="c1">#             # Calculate incentives</span>
<span class="c1">#             incentive_value = (pv * (row[&#39;cbi_usd_p_w&#39;]*1000)) * size_filter</span>

<span class="c1">#             # Calculate system costs</span>
<span class="c1">#             system_cost = pv * agent.loc[&#39;system_capex_per_kw&#39;]</span>


<span class="c1">#         if row[&#39;tech&#39;] == &#39;storage&#39; and not np.isnan(row[&#39;cbi_usd_p_wh&#39;]):</span>
<span class="c1">#             # Size filer calls a function to check for valid system size limitations - a boolean so if the size in invalid it will add zero&#39;s to the results df</span>
<span class="c1">#             size_filter = check_minmax(batt_kwh, row[&#39;min_kwh&#39;], row[&#39;max_kwh&#39;])</span>
<span class="c1">#             size_filter = size_filter * check_minmax(batt_kw, row[&#39;min_kw&#39;], row[&#39;max_kw&#39;])</span>

<span class="c1">#             # Calculate incentives</span>
<span class="c1">#             incentive_value = (row[&#39;cbi_usd_p_wh&#39;] * batt_kwh + row[&#39;cbi_usd_p_w&#39;] * batt_kw) * 1000  * size_filter</span>

<span class="c1">#             # Calculate system costs</span>
<span class="c1">#             system_cost = (batt_kw * agent.loc[&#39;batt_capex_per_kw&#39;]) + (batt_kwh * agent.loc[&#39;batt_capex_per_kwh&#39;])</span>

<span class="c1">#         result += check_incentive_constraints(row, incentive_value, system_cost)</span>

<span class="c1">#     return np.array(result)</span>


<span class="c1"># #%%</span>
<span class="c1"># def calculate_production_based_incentives(pv, kwh_by_timestep, agent):</span>

<span class="c1">#     # Get State Incentives that have a valid Production Based Incentive value</span>
<span class="c1">#     pbi_list = agent.loc[&#39;state_incentives&#39;].loc[pd.notnull(agent.loc[&#39;state_incentives&#39;][&#39;pbi_usd_p_kwh&#39;])]</span>

<span class="c1">#     # Create a empty dataframe to store cumulative pbi&#39;s for each system configuration (each system should have an array as long as the number of years times the number of timesteps per year)</span>
<span class="c1">#     result = np.tile(np.array([0]*agent.loc[&#39;economic_lifetime_yrs&#39;]*agent.loc[&#39;timesteps_per_year&#39;]), (1,1))</span>
    
<span class="c1">#     #Loop through incentives</span>
<span class="c1">#     for row in pbi_list.to_dict(&#39;records&#39;):</span>
<span class="c1">#         #Build boolean array to express if system sizes are valid</span>
<span class="c1">#         size_filter = check_minmax(pv, row[&#39;min_kw&#39;], row[&#39;max_kw&#39;])</span>

<span class="c1">#         if row[&#39;tech&#39;] == &#39;solar&#39;:</span>
<span class="c1">#             # Assume flat rate timestep function for PBI</span>
<span class="c1">#             default_expiration = datetime.date(agent.loc[&#39;year&#39;] + agent.loc[&#39;economic_lifetime_yrs&#39;], 1, 1)</span>
<span class="c1">#             fn = {&#39;function&#39;:eqn_flat_rate,</span>
<span class="c1">#                   &#39;row_params&#39;:[&#39;pbi_usd_p_kwh&#39;,&#39;incentive_duration_yrs&#39;,&#39;end_date&#39;],</span>
<span class="c1">#                   &#39;default_params&#39;:[0, agent.loc[&#39;economic_lifetime_yrs&#39;], default_expiration],</span>
<span class="c1">#                   &#39;additional_params&#39;:[agent.loc[&#39;year&#39;], agent.loc[&#39;timesteps_per_year&#39;]]}</span>



<span class="c1">#             # Vectorize the function</span>
<span class="c1">#             f =  np.vectorize(fn[&#39;function&#39;](row, fn[&#39;row_params&#39;], fn[&#39;default_params&#39;], fn[&#39;additional_params&#39;]))</span>

<span class="c1">#             # Apply the function to each row (containing an array of timestep values)</span>
<span class="c1">#             incentive_value = kwh_by_timestep * f(list(range(0,len(kwh_by_timestep))))</span>

<span class="c1">#             #Add the pbi the cumulative total</span>
<span class="c1">#             result = result + list(incentive_value * size_filter)</span>

<span class="c1">#     #Sum the incentive at each timestep by year for each system size</span>
<span class="c1">#     result =  [np.array([sum(x) for x in np.split(x,agent.loc[&#39;economic_lifetime_yrs&#39;] )]) for x in result]</span>

<span class="c1">#     return result</span>


<span class="c1">#%%</span>
<div class="viewcode-block" id="check_minmax"><a class="viewcode-back" href="../../api.html#python.financial_functions.check_minmax">[docs]</a><span class="k">def</span> <span class="nf">check_minmax</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">min_</span><span class="p">,</span> <span class="n">max_</span><span class="p">):</span>
    <span class="c1">#Returns 1 if the value is within a valid system size limitation - works for single numbers and arrays (assumes valid is system size limitation are not known)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># output = value.apply(lambda x: True)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_</span><span class="p">,</span><span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">min_</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">*</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">min_</span><span class="p">)</span>
            <span class="c1"># output = output * value.apply(lambda x: x &gt;= min_)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">max_</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">*</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">max_</span><span class="p">)</span>
            <span class="c1">#output = output * value.apply(lambda x: x &lt;= max_)</span>

    <span class="k">return</span> <span class="n">output</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="get_expiration"><a class="viewcode-back" href="../../api.html#python.financial_functions.get_expiration">[docs]</a><span class="k">def</span> <span class="nf">get_expiration</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="n">current_year</span><span class="p">,</span> <span class="n">timesteps_per_year</span><span class="p">):</span>
    <span class="c1">#Calculates the timestep at which the end date occurs based on pytoh datetime.date objects and a number of timesteps per year</span>
    <span class="k">return</span>  <span class="nb">float</span><span class="p">(((</span><span class="n">end_date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">current_year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">days</span> <span class="o">/</span> <span class="mf">365.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">timesteps_per_year</span><span class="p">)</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="eqn_builder"><a class="viewcode-back" href="../../api.html#python.financial_functions.eqn_builder">[docs]</a><span class="k">def</span> <span class="nf">eqn_builder</span><span class="p">(</span><span class="n">method</span><span class="p">,</span><span class="n">incentive_info</span><span class="p">,</span> <span class="n">info_params</span><span class="p">,</span> <span class="n">default_params</span><span class="p">,</span><span class="n">additional_data</span><span class="p">):</span>
    <span class="c1">#Builds an equation to scale a series of timestep values</span>
        <span class="c1">#method:            &#39;linear_decay&#39; linearly drop from the full price to zero at a given timestep (used for SREC&#39;s currently)</span>
        <span class="c1">#                   &#39;flat_rate&#39; used as a defualt to keep the consistent value until an endpoint at which point the value is always zero</span>
        <span class="c1">#incentive_info:    a row from the agent[&#39;state_incentives&#39;] dataframe from which to draw info to customize and equation</span>
        <span class="c1">#incentive params:  an array containing the names of the params in agent[&#39;state_incentives&#39;] to use in the equation</span>
        <span class="c1">#default params:    an array of default values for each incentive param. Entries must match the order of the incentive params.</span>
        <span class="c1">#additional_data:    Addtional data can be used to customize the equation</span>

    <span class="c1">#Loop through params and grab the default value is the agent[&#39;state_incentives&#39;] entry does not have a valid value for it</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">info_params</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">incentive_info</span><span class="p">[</span><span class="n">r</span><span class="p">]):</span>
                <span class="n">incentive_info</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">incentive_info</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">incentive_info</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">pbi_usd_p_kwh</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">incentive_info</span><span class="p">[</span><span class="n">info_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">years</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">incentive_info</span><span class="p">[</span><span class="n">info_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">incentive_info</span><span class="p">[</span><span class="n">info_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

    <span class="n">current_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">additional_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">timesteps_per_year</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">additional_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1">#Get the timestep at which the incentive expires</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#Find expiration timestep by explict program end date</span>
        <span class="n">expiration</span> <span class="o">=</span> <span class="n">get_expiration</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="n">current_year</span><span class="p">,</span> <span class="n">timesteps_per_year</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1">#Assume the incetive applies for all years if there is an error in the previous step</span>
        <span class="n">expiration</span> <span class="o">=</span> <span class="n">years</span> <span class="o">*</span> <span class="n">timesteps_per_year</span>

    <span class="c1">#Reduce the expiration if there is a cap on the number of years the incentive can be applied</span>
    <span class="n">expiration</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">years</span> <span class="o">*</span> <span class="n">timesteps_per_year</span><span class="p">,</span> <span class="n">expiration</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span><span class="s1">&#39;linear_decay&#39;</span><span class="p">:</span>
        <span class="c1">#Linear decline to zero at expiration</span>
        <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">expiration</span><span class="p">:</span>
                <span class="k">return</span>  <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expiration</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">fraction</span> <span class="o">=</span> <span class="n">expiration</span> <span class="o">-</span> <span class="n">ts</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fraction</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">fraction</span> <span class="o">*</span> <span class="p">(</span><span class="n">pbi_usd_p_kwh</span> <span class="o">+</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">pbi_usd_p_kwh</span> <span class="o">/</span> <span class="n">expiration</span><span class="p">)</span> <span class="o">*</span> <span class="n">ts</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">function</span>


    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;flat_rate&#39;</span><span class="p">:</span>
        <span class="c1"># Flat rate until expiration, and then zero</span>
        <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">expiration</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expiration</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">fraction</span> <span class="o">=</span> <span class="n">expiration</span> <span class="o">-</span> <span class="n">ts</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fraction</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">return</span> <span class="n">fraction</span> <span class="o">*</span> <span class="n">pbi_usd_p_kwh</span>

        <span class="k">return</span> <span class="n">function</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="eqn_linear_decay_to_zero"><a class="viewcode-back" href="../../api.html#python.financial_functions.eqn_linear_decay_to_zero">[docs]</a><span class="k">def</span> <span class="nf">eqn_linear_decay_to_zero</span><span class="p">(</span><span class="n">incentive_info</span><span class="p">,</span> <span class="n">info_params</span><span class="p">,</span> <span class="n">default_params</span><span class="p">,</span><span class="n">additional_params</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">eqn_builder</span><span class="p">(</span><span class="s1">&#39;linear_decay&#39;</span><span class="p">,</span><span class="n">incentive_info</span><span class="p">,</span> <span class="n">info_params</span><span class="p">,</span> <span class="n">default_params</span><span class="p">,</span><span class="n">additional_params</span><span class="p">)</span></div>


<span class="c1">#%%</span>
<div class="viewcode-block" id="eqn_flat_rate"><a class="viewcode-back" href="../../api.html#python.financial_functions.eqn_flat_rate">[docs]</a><span class="k">def</span> <span class="nf">eqn_flat_rate</span><span class="p">(</span><span class="n">incentive_info</span><span class="p">,</span> <span class="n">info_params</span><span class="p">,</span> <span class="n">default_params</span><span class="p">,</span><span class="n">additional_params</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">eqn_builder</span><span class="p">(</span><span class="s1">&#39;flat_rate&#39;</span><span class="p">,</span> <span class="n">incentive_info</span><span class="p">,</span> <span class="n">info_params</span><span class="p">,</span> <span class="n">default_params</span><span class="p">,</span><span class="n">additional_params</span><span class="p">)</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, NREL

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>